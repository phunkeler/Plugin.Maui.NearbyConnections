<BottomSheet x:Class="NearbyChat.Controls.ChatBottomSheet"
             ShowHeader="True"
             SizeMode="FitToContent"
             CornerRadius="24"
             IsDraggable="False"
             BackgroundColor="{AppThemeBinding Light={StaticResource LightBackgroundPrimary}, Dark={StaticResource DarkBackgroundPrimary}}"
             x:DataType="ChatViewModel"
             Margin="{StaticResource SpacingXL}">
    <BottomSheet.Header>
        <BottomSheetHeader
            ShowCloseButton="True">
            <ContentView>
                <VerticalStackLayout Spacing="{StaticResource SpacingSM}">
                    <Grid>
                        <Label Text="{Binding Device.DisplayName}"
                               HorizontalOptions="Start"
                               Style="{StaticResource CardTitle}"/>
                    </Grid>
                    <BoxView HeightRequest="1"
                             VerticalOptions="End"
                             BackgroundColor="Grey"/>
                </VerticalStackLayout>
            </ContentView>
        </BottomSheetHeader>
    </BottomSheet.Header>
    <BottomSheet.Content>
        <BottomSheetContent>
            <Grid RowDefinitions="*, Auto"
                  RowSpacing="{StaticResource SpacingXL}">
                <CollectionView ItemsSource="{Binding Messages}"
                                ItemsUpdatingScrollMode="KeepLastItemInView"
                                Background="Transparent">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical"
                                           ItemSpacing="{StaticResource SpacingXS}"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="ChatMessage">
                            <Grid>
                                <Border x:Name="Bubble"
                                        StrokeThickness="0"
                                        Padding="6"
                                        MaximumWidthRequest="520"
                                        Background="#F1F1F1"
                                        HorizontalOptions="Start"
                                        StrokeShape="RoundRectangle 14">
                                    <VerticalStackLayout Spacing="4">
                                        <Label x:Name="MessageText"
                                               Text="{Binding Text}"
                                               TextColor="#222"
                                               LineBreakMode="WordWrap"/>
                                        <Label Text="{Binding Timestamp, StringFormat='{0:t}'}"
                                               FontSize="10"
                                               TextColor="#888"
                                               HorizontalTextAlignment="End"/>
                                    </VerticalStackLayout>
                                    <Border.Triggers>
                                        <!-- User messages: right aligned, accent background -->
                                        <DataTrigger TargetType="Border"
                                                     Binding="{Binding From}"
                                                     Value="Me">
                                            <Setter Property="HorizontalOptions"
                                                    Value="End"/>
                                            <Setter Property="Background"
                                                    Value="#D1E8FF"/>
                                        </DataTrigger>
                                    </Border.Triggers>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <Grid ColumnDefinitions="*, Auto, Auto"
                      ColumnSpacing="{StaticResource SpacingSM}"
                      Grid.Row="1">
                    <Entry
                        HeightRequest="44"
                        Placeholder="Type a message..."
                        Text="{Binding Message}"
                        TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"/>
                    <ImageButton
                        Grid.Column="1"
                        Command="{Binding SendCommand}">
                        <ImageButton.Source>
                            <FontImageSource
                                FontFamily="NearbyChatIcons"
                                Glyph="{StaticResource icon-send}"
                                Color="{AppThemeBinding Light={StaticResource LightTextQuaternary}, Dark={StaticResource DarkTextQuaternary}}"/>
                        </ImageButton.Source>
                    </ImageButton>
                    <ImageButton
                        Grid.Column="2"
                        Command="{Binding AttachCommand}">
                        <ImageButton.Source>
                            <FontImageSource
                                FontFamily="NearbyChatIcons"
                                Glyph="{StaticResource icon-link}"
                                Color="{AppThemeBinding Light={StaticResource LightTextQuaternary}, Dark={StaticResource DarkTextQuaternary}}"/>
                        </ImageButton.Source>
                    </ImageButton>
                </Grid>
            </Grid>
        </BottomSheetContent>
    </BottomSheet.Content>
</BottomSheet>
