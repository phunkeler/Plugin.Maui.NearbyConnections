<?xml version="1.0" encoding="utf-8" ?>
<pages:BasePage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
                xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                xmlns:vm="clr-namespace:NearbyChat.ViewModels"
                xmlns:pages="clr-namespace:NearbyChat.Pages"
                xmlns:models="clr-namespace:NearbyChat.Models"
                xmlns:sf="clr-namespace:Syncfusion.Maui.Toolkit.SegmentedControl;assembly=Syncfusion.Maui.Toolkit"
                xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
                x:Class="NearbyChat.Pages.LoginPage"
                x:Name="login"
                x:TypeArguments="vm:LoginPageViewModel"
                x:DataType="vm:LoginPageViewModel">
    <pages:BasePage.Resources>
        <ResourceDictionary>
            <toolkit:IsNotNullConverter x:Key="IsNotNullConverter"/>
        </ResourceDictionary>
    </pages:BasePage.Resources>

    <pages:BasePage.Behaviors>
        <toolkit:EventToCommandBehavior
            BindingContext="{Binding Path=BindingContext, Source={x:Reference login}, x:DataType=pages:BasePage}"
            EventName="NavigatedTo"
            Command="{Binding NavigatedToCommand}"/>
        <toolkit:EventToCommandBehavior
            BindingContext="{Binding Path=BindingContext, Source={x:Reference login}, x:DataType=pages:BasePage}"
            EventName="NavigatedFrom"
            Command="{Binding NavigatedFromCommand}"/>
        <toolkit:EventToCommandBehavior
            BindingContext="{Binding Path=BindingContext, Source={x:Reference login}, x:DataType=pages:BasePage}"
            EventName="Appearing"
            Command="{Binding AppearingCommand}"/>
    </pages:BasePage.Behaviors>

    <Grid>
        <ScrollView>
            <Grid Padding="{DynamicResource SpacingXL}"
                  RowSpacing="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <StackLayout Grid.Row="1"
                             Spacing="{StaticResource Spacing2XL}"
                             MaximumWidthRequest="400"
                             HorizontalOptions="Center">

                    <!-- App Header -->
                    <StackLayout Spacing="{DynamicResource SpacingXL}">
                        <!-- App Icon -->
                        <Image Source="nuget.png"
                               HeightRequest="80"
                               WidthRequest="80"
                               HorizontalOptions="Center"/>

                        <!-- App Title and Description -->
                        <StackLayout Spacing="{StaticResource SpacingSM}">
                            <Label Text="NearbyChat"
                                   Style="{StaticResource Display1}"
                                   HorizontalTextAlignment="Center"/>

                            <Label Style="{StaticResource Body1}"
                                   HorizontalTextAlignment="Center">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="Chat instantly with nearby devices using "/>
                                        <Span Text="Plugin.Maui.NearbyConnections"
                                              FontAttributes="Bold"
                                              TextColor="{StaticResource PrimaryBlue600}"/>
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                        </StackLayout>
                    </StackLayout>

                    <!-- Login Card -->
                    <Border Style="{StaticResource CardFrame}"
                            Padding="{DynamicResource SpacingXL}">
                        <StackLayout Spacing="{DynamicResource SpacingXL}">

                            <!-- Card Header -->
                            <Label Text="Create Identity"
                                   Style="{StaticResource Headline1}"
                                   HorizontalTextAlignment="Center"/>

                            <!-- Avatar Selection -->
                            <Grid RowDefinitions="Auto,*"
                                  RowSpacing="{StaticResource SpacingLG}">

                                <Label Text="Choose Avatar"
                                       Style="{StaticResource LabelMedium}"/>

                                <CollectionView Grid.Row="1"
                                                HorizontalScrollBarVisibility="Never"
                                                x:Name="AvatarList"
                                                ItemsSource="{Binding Avatars}"
                                                SelectionMode="Single"
                                                SelectedItem="{Binding SelectedAvatar}">
                                    <CollectionView.Behaviors>
                                        <toolkit:EventToCommandBehavior
                                            x:TypeArguments="SelectionChangedEventArgs"
                                            BindingContext="{Binding Path=BindingContext, Source={x:Reference AvatarList}, x:DataType=CollectionView}"
                                            EventName="SelectionChanged"
                                            Command="{Binding AvatarSelectionChangedCommand}"/>
                                    </CollectionView.Behaviors>
                                    <CollectionView.ItemsLayout>
                                        <LinearItemsLayout Orientation="Horizontal"
                                                           ItemSpacing="{StaticResource SpacingMD}"/>
                                    </CollectionView.ItemsLayout>
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="models:Avatar">
                                            <!-- Wrap AvatarView so we can control CollectionView's default selected item color -->
                                            <ContentView BackgroundColor="Transparent"
                                                         Style="{StaticResource AvatarList-Container}"
                                                         Padding="0">
                                                <toolkit:AvatarView
                                                    Style="{StaticResource AvatarList-Selected}"
                                                    BackgroundColor="{Binding BackgroundColor}"
                                                    BorderColor="{Binding BorderColor}"
                                                    BorderWidth="{Binding BorderWidth}"
                                                    ImageSource="{Binding ImageSource}"
                                                    Padding="{Binding Padding}"
                                                    Text="{Binding Text}"
                                                    TextColor="{Binding TextColor}"/>
                                            </ContentView>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>

                            <!-- Username Input -->
                            <StackLayout Spacing="{StaticResource SpacingSM}">
                                <Label Text="Display Name"
                                       Style="{StaticResource LabelMedium}"/>
                                <Border Style="{StaticResource InputFrame}">
                                    <Entry x:Name="UsernameEntry"
                                           Placeholder="Enter your name"
                                           Style="{StaticResource TextInput}"
                                           TextChanged="UsernameEntry_TextChanged"
                                           MaxLength="20"/>
                                </Border>
                            </StackLayout>

                            <!-- Login Button -->
                            <Button x:Name="LoginButton"
                                    Text="ðŸ“± Start Nearby Chat"
                                    Style="{StaticResource PrimaryButton}"
                                    Command="{Binding LoginCommand}"/>
                        </StackLayout>
                    </Border>

                    <!-- Footer -->
                    <StackLayout Spacing="{StaticResource SpacingSM}">


                    </StackLayout>
                </StackLayout>
            </Grid>
        </ScrollView>
    </Grid>
</pages:BasePage>